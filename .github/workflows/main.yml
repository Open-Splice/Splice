name: Splice CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    name: Build & Test (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS
          - os: macos
            arch: x64
            runner: macos-15-intel
          - os: macos
            arch: arm64
            runner: macos-14
          # Linux
          - os: linux
            arch: x64
            runner: ubuntu-22.04
          - os: linux
            arch: arm64
            runner: ubuntu-22.04
          # Windows
          - os: windows
            arch: x64
            runner: windows-2022
          - os: windows
            arch: arm64
            runner: windows-2022

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Make build script executable
        run: chmod +x build.sh
        shell: bash

      - name: Run build script (CI mode)
        run: CI=true ./build.sh
        shell: bash

      - name: Verify binaries exist
        run: |
          ls -lh ./Splice || true
          ls -lh ./spbuild || true
        shell: bash

      - name: Run tests
        run: |
          if [ -d build ]; then
            cd build
            ctest --output-on-failure || true
          else
            echo "No build dir found, skipping tests"
          fi
        shell: bash
      - name: Testing Splice Code
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ./bin/spbuild.exe test/main.sp main.spbc
            ./bin/Splice.exe main.spbc
          else
            ./bin/spbuild test/main.sp main.spbc
            ./bin/Splice main.spbc
          fi

      - name: Mark as finished
        run: echo "Build completed on ${{ matrix.os }}-${{ matrix.arch }}" > finish.txt
        shell: bash

      - name: Upload finish artifact
        uses: actions/upload-artifact@v4
        with:
          name: splice-finish-${{ matrix.os }}-${{ matrix.arch }}
          path: finish.txt
